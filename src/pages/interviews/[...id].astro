---
import Layout from "@/layouts/Layout.astro";
import { getSlugFromId, getIndexById, isProd } from "@/utils";
import {
  type CollectionEntry,
  getCollection,
  getEntry,
  render,
} from "astro:content";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
export async function getStaticPaths() {
  const collection = await getCollection("interviews", ({ data }) => {
    return isProd ? data.draft !== true : true;
  });
  const interviews = collection.sort((a, b) => {
    const aDate = a.data.published;
    const bDate = b.data.published;
    return Date.parse(bDate.toString()) - Date.parse(aDate.toString());
  });
  return interviews.map((interview, index) => {
    const id = getSlugFromId(interview.id);
    const issue = getIndexById(interviews, interview.id);
    const totalIssues = interviews.length;
    const previous =
      index < totalIssues - 1 ? interviews[index + 1] : undefined;
    const next = index > 0 ? interviews[index - 1] : undefined;
    return {
      params: { id },
      props: {
        issue,
        interview,
        previous,
        next,
      },
    };
  });
}
type Props = {
  issue: string;
  interview: CollectionEntry<"interviews">;
  previous: CollectionEntry<"interviews"> | undefined;
  next: CollectionEntry<"interviews"> | undefined;
};
const { issue, interview, previous, next } = Astro.props;
const { Content } = await render(interview);
const thumbnail = interview.data.gallery?.at(0);
---

<Layout
  title={interview.data.title}
  description={interview.data.description}
  image={interview.data.image}
>
  <header class="bg-primary px-4 sm:px-8 pb-4 sm:pb-8 rounded-b-lg pt-24">
    <div class="size-9 sm:size-18 relative overflow-hidden rounded-full mb-4">
      <Image
        src={interview.data.avatar}
        width={64}
        height={64}
        alt=""
        class="absolute size-full"
      />
    </div>
    <h1
      class="text-3xl sm:text-5xl tracking-tight text-balance text-primary-foreground max-w-prose leading-[1.1]"
    >
      {interview.data.title}.
      <span
        class="text-[color-mix(in_srgb,var(--color-primary-foreground),var(--color-primary)_50%)]"
        >{interview.data.description}</span
      >
    </h1>
  </header>
  {
    thumbnail ? (
      <div class="mt-4 md:hidden">
        <button
          class="group/button bg-primary text-primary-foreground rounded-lg w-full h-9 px-4 flex items-center justify-center gap-x-2 font-medium"
          type="button"
          data-a11y-dialog-show="gallery-dialog"
        >
          <Icon name="gallery" class="size-4 text-secondary" />
          View gallery
        </button>
      </div>
    ) : null
  }
  <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-x-4 bg-muted rounded-lg">
    <div class="md:col-span-3 lg:col-span-2 p-4 sm:p-8">
      <div class="prose">
        <Content />
      </div>
      {
        interview.data.products ? (
          <>
            <h2 class="mt-8 flex items-center gap-x-4 font-semibold text-xl tracking-tight text-primary">
              Products referenced&nbsp;&not;
            </h2>
            <ul class="mt-4 space-y-4">
              {interview.data.products?.map(async ({ id }, i) => {
                const product = await getEntry("products", id);
                if (!product) {
                  return null;
                }
                return (
                  <li id={(i + 1).toString()}>
                    <span class="text-muted-foreground font-mono uppercase text-xs block">
                      {product.data.description}
                    </span>
                    <a
                      href={product.data.link}
                      target="_blank"
                      class="font-medium underline decoration-2 decoration-accent hover:bg-accent"
                    >
                      {product.data.title}
                    </a>
                  </li>
                );
              })}
            </ul>
          </>
        ) : null
      }
    </div>
    <div
      class="hidden relative md:flex flex-col justify-end p-4 sm:p-8 col-start-4"
    >
      {
        thumbnail ? (
          <button
            class="aspect-[3/2] rounded-sm overflow-hidden sticky bottom-8 group/thumbnail cursor-zoom-in bg-primary"
            type="button"
            data-a11y-dialog-show="gallery-dialog"
          >
            <Image
              src={thumbnail.src}
              alt={thumbnail.alt}
              width={1500}
              height={1000}
              class="absolute inset-0 size-full object-cover group-hover/thumbnail:opacity-5 transition duration-250 ease-custom"
            />
            <span class="relative text-xs font-mono uppercase text-accent opacity-0 group-hover/thumbnail:opacity-100 transition duration-250 ease-custom pointer-coarse:opacity-100">
              View gallery
            </span>
          </button>
        ) : null
      }
    </div>
  </div>

  <!-- <section class="p-8 bg-secondary rounded-lg mt-4"></section> -->

  <div
    slot="dialog"
    id="gallery-dialog"
    class="dialog-container"
    aria-labelledby="gallery-dialog-title"
    aria-hidden="true"
  >
    <div data-a11y-dialog-hide class="dialog-overlay"></div>
    <div role="document" class="dialog-content">
      <span
        class="absolute top-4 left-4 text-xs font-mono text-accent z-10 inline-flex items-baseline"
        aria-hidden="true"
      >
        FIG_<number-flow id="gallery-figcaption" data-will-change></number-flow>
      </span>
      <button
        type="button"
        data-a11y-dialog-hide
        aria-label="Close dialog"
        class="group/button p-4 absolute top-0 right-0 z-10 text-accent"
      >
        <span
          class="size-7 grid place-content-center rounded-full group-hover/button:bg-primary transition-colors ease-custom duration-250"
        >
          <Icon name="close" class="size-4" />
        </span>
      </button>
      <h1 id="gallery-dialog-title" class="sr-only">Gallery images</h1>
      {
        interview.data.gallery ? (
          <figure class:list={["embla", "relative"]}>
            <div class:list={["embla__viewport", "overflow-hidden"]}>
              <div class:list={["embla__container", "flex"]}>
                {interview.data.gallery.map((img, i) => {
                  return (
                    <div
                      class:list={[
                        "embla__slide",
                        "relative overflow-hidden aspect-[3/2] flex-[0_0_100%] min-w-0 grid place-content-center",
                      ]}
                    >
                      <Image
                        src={img.src}
                        alt={img.alt}
                        width={1500}
                        height={1000}
                        loading={i === 0 ? "eager" : "lazy"}
                        class="absolute w-full h-full object-cover"
                      />
                    </div>
                  );
                })}
              </div>
            </div>
            {interview.data.gallery.length > 1 ? (
              <Fragment>
                <button
                  class:list={[
                    "embla__button--prev",
                    "group/button",
                    "absolute top-1/2 -translate-y-1/2 px-4 aspect-square grid place-content-center left-0 transition-opacity ease-custom duration-250",
                    "disabled:opacity-0",
                  ]}
                  disabled
                  type="button"
                >
                  <span class="sr-only">Previous</span>
                  <span
                    class="size-7 bg-accent rounded-full text-primary grid place-content-center overflow-hidden"
                    aria-hidden="true"
                  >
                    <Icon
                      name="arrow-left"
                      class="size-4 [grid-area:1/1] translate-x-6 group-hover/button:translate-x-0 motion-reduce:transition-none group-focus-visible/button:translate-x-0 transition-transform duration-250 ease-custom"
                    />
                    <Icon
                      name="arrow-left"
                      class="size-4 [grid-area:1/1] opacity-70 group-hover/button:-translate-x-6 motion-reduce:transition-none group-focus-visible/button:translate-x-6 transition-transform duration-250 ease-custom"
                    />
                  </span>
                </button>
                <button
                  class:list={[
                    "embla__button--next",
                    "group/button",
                    "absolute top-1/2 -translate-y-1/2 px-4 aspect-square grid place-content-center right-0 transition-opacity ease-custom duration-250",
                    "disabled:opacity-0",
                  ]}
                  type="button"
                >
                  <span class="sr-only">Next</span>
                  <span
                    class="size-7 bg-accent rounded-full text-primary grid place-content-center overflow-hidden"
                    aria-hidden="true"
                  >
                    <Icon
                      name="arrow-right"
                      class="size-4 [grid-area:1/1] -translate-x-6 group-hover/button:translate-x-0 motion-reduce:transition-none group-focus-visible/button:translate-x-0 transition-transform duration-250 ease-custom"
                    />
                    <Icon
                      name="arrow-right"
                      class="size-4 [grid-area:1/1] opacity-70 group-hover/button:translate-x-6 motion-reduce:transition-none group-focus-visible/button:translate-x-6 transition-transform duration-250 ease-custom"
                    />
                  </span>
                </button>
              </Fragment>
            ) : null}
          </figure>
        ) : null
      }
    </div>
  </div>
</Layout>

<style>
  .dialog-container,
  .dialog-overlay {
    position: fixed;
    inset: 0;
  }

  .dialog-container {
    z-index: 2;
    display: flex;
  }

  .dialog-container[aria-hidden="true"] {
    display: none;
  }

  .dialog-overlay {
    background-color: color-mix(in srgb, var(--color-primary) 95%, transparent);
    backdrop-filter: blur(12px);
    transition: opacity 250ms;
    opacity: 1;

    @starting-style {
      opacity: 0;
    }
  }

  .dialog-content {
    margin: auto;
    z-index: 2;
    position: relative;
    background-color: var(--color-secondary);
    aspect-ratio: 3 / 2;
    height: min(calc(100vh - 4rem), calc((100vw - 2rem) * 2 / 3));
    border-radius: var(--radius-lg);
    overflow: hidden;
    opacity: 1;
    transform: scale(1);
    transition-property: opacity, transform;
    transition-duration: 0.3s;

    @starting-style {
      opacity: 0;
      transform: scale(0.95);
    }
  }
</style>

<script>
  import "number-flow";
  import A11yDialog from "a11y-dialog";
  import { disableBodyScroll, enableBodyScroll } from "@/lib/body-scroll-lock";
  import { addPrevNextBtnsClickHandlers } from "@/lib/embla";
  import EmblaCarousel, { type EmblaOptionsType } from "embla-carousel";

  const OPTIONS: EmblaOptionsType = {};

  (function () {
    const element = document.querySelector("#gallery-dialog") as HTMLElement;
    const dialog = new A11yDialog(element);
    let emblaApi: ReturnType<typeof EmblaCarousel> | undefined;
    let cleanupHandlers: (() => void) | undefined;

    const initEmbla = () => {
      const emblaNode = document.querySelector(".embla") as HTMLElement;
      if (!emblaNode) return;

      const viewportNode = emblaNode.querySelector(
        ".embla__viewport"
      ) as HTMLElement;
      const prevBtnNode = emblaNode.querySelector(
        ".embla__button--prev"
      ) as HTMLElement;
      const nextBtnNode = emblaNode.querySelector(
        ".embla__button--next"
      ) as HTMLElement;
      const figcaptionElement = document.querySelector(
        "#gallery-figcaption"
      ) as any;

      emblaApi = EmblaCarousel(viewportNode, OPTIONS);

      if (figcaptionElement && typeof figcaptionElement.update === "function") {
        figcaptionElement.format = {
          minimumIntegerDigits: 3,
          useGrouping: false,
        };

        const initialIndex = emblaApi.selectedScrollSnap();
        figcaptionElement.update(initialIndex + 1);
      } else {
        console.error(
          "number-flow element not ready or update method not available"
        );
      }

      const onSelect = () => {
        if (figcaptionElement && emblaApi) {
          const selectedIndex = emblaApi.selectedScrollSnap();
          figcaptionElement.update(selectedIndex + 1);
        }
      };

      emblaApi.on("select", onSelect);

      cleanupHandlers = addPrevNextBtnsClickHandlers(
        emblaApi,
        prevBtnNode,
        nextBtnNode
      );
    };

    const cleanupEmbla = () => {
      if (cleanupHandlers) {
        cleanupHandlers();
      }
      if (emblaApi) {
        emblaApi.destroy();
      }
      emblaApi = undefined;
      cleanupHandlers = undefined;
    };

    dialog
      .on("show", () => {
        disableBodyScroll(element, { reserveScrollBarGap: true });
        initEmbla();
      })
      .on("hide", () => {
        enableBodyScroll(element);
        cleanupEmbla();
      });
  })();
</script>
