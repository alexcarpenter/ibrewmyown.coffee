---
import { getSlugFromId, isProd } from "@/utils";
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
const collection = await getCollection("interviews", ({ data }) => {
  return isProd ? data.draft !== true : true;
});
const interviews = collection.sort((a, b) => {
  const aDate = a.data.published;
  const bDate = b.data.published;
  return Date.parse(bDate.toString()) - Date.parse(aDate.toString());
});
---

<Layout>
  <header
    class="bg-primary px-4 sm:px-8 pb-4 sm:pb-8 rounded-b-lg pt-24 sm:pt-72"
  >
    <h1
      class="text-3xl sm:text-5xl tracking-tight text-balance text-primary-foreground leading-[1.1]"
    >
      I Brew My Own Coffee.
      <span class="text-secondary"
        >A collection of personal coffee brewing setups.</span
      >
    </h1>
  </header>
  <!-- <a
    href="/2025-holiday-gift-guide"
    class="mt-4 rounded-lg bg-red-600 py-4 px-8 text-center group/card"
  >
    <h3 class="font-semibold tracking-tight text-primary">
      <span>
        View 2025 Holiday Gift Guide
        <span
          class="absolute h-[1lh] inline-flex items-center pl-1 overflow-clip"
        >
          <Icon
            name="arrow-right"
            class="size-4 opacity-0 group-hover/card:opacity-70 motion-reduce:transition-none duration-250 -translate-x-6 group-hover/card:translate-x-0 transition ease-custom"
          />
        </span>
      </span>
    </h3>
    <span class="mt-1 text-primary max-w-md flex mx-auto"
      >Discover the best coffee gifts for the holidaysâ€”espresso machines,
      drippers, brewers, and bean subscriptions that coffee lovers will actually
      use every day.
    </span>
  </a> -->
  <section class="mt-4">
    <ul
      class:list={[
        "grid gap-4",
        "grid-cols-1",
        "md:grid-cols-2",
        "lg:grid-cols-4",
      ]}
    >
      <li
        class:list={[
          "flex flex-col group/list-item",
          "md:[&:nth-child(3n+1)]:col-span-2",
          "lg:[&:nth-child(3n+1)]:col-span-1",
          "lg:[&:nth-child(6n+1)]:col-span-2",
          "lg:[&:nth-child(6n)]:col-span-2",
        ]}
      >
        <article
          class:list={[
            "group/card isolate relative rounded-lg flex-1 flex overflow-hidden bg-muted",
            "group-[&:nth-child(2n+1)]/list-item:bg-secondary",
            "md:group-[&:nth-child(2n+1)]/list-item:bg-muted",
            "md:group-[&:nth-child(3n+1)]/list-item:bg-secondary",
            "lg:group-[&:nth-child(3n+1)]/list-item:bg-muted",
            "lg:group-[&:nth-child(6n+1)]/list-item:bg-secondary",
            "lg:group-[&:nth-child(6n)]/list-item:bg-secondary",
          ]}
        >
          <div class="p-4 sm:p-8 flex-1 flex flex-col">
            <header class="mb-24 sm:mb-56">
              <div class="mb-4 h-9 relative">
                <svg
                  aria-hidden="true"
                  viewBox="0 0 138 34"
                  fill="none"
                  class="h-full text-accent"
                  ><path
                    fill="currentColor"
                    d="M134.42 4c1.984 0 3.04 1.12 3.04 3.136v9.504h-3.84v10.784c0 .704.288 1.056.8 1.056s.736-.32.736-.896v-9.952h2.304v10.016c0 1.792-1.184 2.912-3.04 2.912-1.984 0-3.136-1.12-3.136-3.232V7.264c0-2.144 1.184-3.264 3.136-3.264Zm0 2.048c-.544 0-.8.416-.8.992v7.616h1.536V7.04c0-.608-.224-.992-.736-.992ZM125.576 4.032c1.024 0 1.536.704 1.984 1.664V0h2.336v30.4h-2.304v-1.6c-.416 1.024-.992 1.728-2.016 1.728-1.056 0-1.792-.736-1.792-2.272V6.304c0-1.536.736-2.272 1.792-2.272Zm1.216 2.048c-.416 0-.672.32-.672.928v20.544c0 .608.256.928.672.928.416 0 .768-.352.768-1.12V7.2c0-.768-.32-1.12-.768-1.12ZM120.1 0h2.336v3.296H120.1V0Zm0 4.16h2.336V30.4H120.1V4.16ZM116.28 4.16h2.336V30.4H116.6l-.256-1.696c-.416.992-1.216 1.856-2.24 1.824-.96 0-1.6-.64-1.6-2.112V4.16h2.336v23.584c0 .448.224.704.608.704.416 0 .832-.384.832-.992V4.16ZM108.852 29.056c-.32.992-.864 1.504-1.92 1.504-1.344-.032-2.208-1.056-2.208-2.944V3.296c0-2.112 1.152-3.264 3.264-3.264s3.168 1.088 3.168 3.008v9.856h-2.4V3.104c0-.64-.288-.96-.8-.96-.48 0-.8.352-.8.96v24.384c0 .608.288.96.8.96.48 0 .8-.416.8-.96V16.512h-.864V14.4h3.232v16h-1.696l-.416-1.344h-.16ZM100.857 6.144h-1.44v21.184c0 .64.128.992.736.992h.736v2.08h-1.344c-1.472 0-2.464-.8-2.464-2.464V6.144h-1.152V4.16c1.376 0 1.664-1.024 1.792-3.616h1.696V4.16h1.44v1.984Z"
                  ></path><path
                    fill="currentColor"
                    d="M95.083 1.632c-.352 0-.48.224-.48.512V4.16h1.472v1.984h-1.472V30.4h-2.336V6.144h-1.152V4.16h1.152V1.984C92.267.608 93.1 0 94.38 0h1.696v1.632h-.992ZM88.006 0h2.336v3.296h-2.336V0Zm0 4.16h2.336V30.4h-2.336V4.16ZM84.29 29.056c-.32.992-.865 1.504-1.92 1.504-1.345-.032-2.209-1.056-2.209-2.944V3.296c0-2.112 1.152-3.264 3.264-3.264s3.168 1.088 3.168 3.008v9.856h-2.4V3.104c0-.64-.288-.96-.8-.96-.48 0-.8.352-.8.96v24.384c0 .608.288.96.8.96.48 0 .8-.416.8-.96V16.512h-.864V14.4h3.232v16h-1.696l-.416-1.344h-.16ZM73.013 24.704l.224-5.536.512-15.008h2.432l-1.856 26.72c-.288 2.272-1.696 2.912-3.328 2.912h-1.568v-2.048h1.12c.544 0 .896-.256.96-.672L69.557 4.16h2.4l.608 15.008.224 5.536h.224ZM66.694 30.4l-.256-1.632c-.448 1.152-1.056 1.792-2.112 1.792-1.088 0-1.856-.864-1.856-2.144v-9.152c0-1.888.608-3.008 2.112-3.68l1.728-.736V6.784c0-.48-.16-.768-.64-.768s-.704.32-.704.768v7.392h-2.272V6.752c0-1.696.96-2.752 2.976-2.752 1.952 0 2.976.992 2.976 2.912V30.4h-1.952Zm-.352-13.248-.736.288c-.576.288-.8.768-.8 1.824v8.352c0 .512.192.864.608.864.448 0 .896-.448.896-1.216l.032-10.112ZM56.857 4.032c1.024 0 1.536.704 1.984 1.664V0h2.336v30.4h-2.304v-1.6c-.416 1.024-.992 1.728-2.016 1.728-1.056 0-1.792-.736-1.792-2.272V6.304c0-1.536.736-2.272 1.792-2.272Zm1.216 2.048c-.416 0-.672.32-.672.928v20.544c0 .608.256.928.672.928.416 0 .768-.352.768-1.12V7.2c0-.768-.32-1.12-.768-1.12ZM51.38 0h2.337v3.296H51.38V0Zm0 4.16h2.337V30.4H51.38V4.16ZM47.6 0h2.336v30.4H47.6V0ZM43.139 4c1.888 0 3.072 1.12 3.072 3.232v20.064c0 2.144-1.152 3.264-3.104 3.264-1.92 0-3.104-1.12-3.104-3.264V7.232C40.003 5.12 41.187 4 43.139 4Zm.736 23.424V7.104c0-.64-.256-1.024-.736-1.024-.512 0-.8.352-.8 1.024v20.32c0 .704.288 1.056.768 1.056.512 0 .768-.384.768-1.056ZM36.16.16h2.433V30.4H36.16V15.776h-1.504V30.4h-2.4V.16h2.4v13.472h1.504V.16ZM24.374 14.528c.288-.736.864-1.216 1.728-1.216 1.12 0 1.792.768 1.792 2.464v11.776c0 1.952-1.152 2.944-3.072 2.944-1.856 0-3.04-.992-3.04-3.008V16.864h2.272v10.688c0 .576.32.864.768.864.416 0 .736-.256.736-.8V16.16c0-.512-.288-.8-.704-.8-.384 0-.608.256-.736.608l-2.24-.512.48-15.296h5.568l-.128 1.984h-3.2l-.384 12.384h.16ZM20.993 28.416V30.4h-6.368v-1.408c0-7.872 3.84-13.44 3.84-17.856V3.008c0-.64-.288-.896-.736-.896s-.736.32-.736.896v8.64h-2.272V2.912c0-1.792 1.152-2.88 3.104-2.88 1.792 0 2.976.992 2.976 2.72v7.52c0 5.92-3.744 12.096-3.744 18.144h3.936ZM10.39.032c1.887 0 3.04 1.024 3.04 3.008v24.448c0 2.016-1.153 3.04-3.04 3.04-1.92 0-3.073-1.024-3.073-3.04V3.04c0-1.984 1.184-3.008 3.072-3.008Zm.671 27.488V3.04c0-.608-.256-.928-.672-.928-.416 0-.704.288-.704.928v24.48c0 .64.256.928.704.928.416 0 .672-.288.672-.928ZM6.368 28.416V30.4H0v-1.408c0-7.872 3.84-13.44 3.84-17.856V3.008c0-.64-.288-.896-.736-.896s-.736.32-.736.896v8.64H.096V2.912C.096 1.12 1.248.032 3.2.032c1.792 0 2.976.992 2.976 2.72v7.52c0 5.92-3.744 12.096-3.744 18.144h3.936Z"
                  ></path></svg
                >
              </div>
              <h3 class="font-semibold tracking-tight text-primary">
                <a
                  href="/2025-holiday-gift-guide"
                  class="before:absolute before:inset-0 before:z-10"
                >
                  Discover the best coffee gifts for the holidays
                  <span
                    class="absolute h-[1lh] inline-flex items-center pl-1 overflow-clip"
                  >
                    <Icon
                      name="arrow-right"
                      class="size-4 opacity-0 group-hover/card:opacity-70 motion-reduce:transition-none duration-250 -translate-x-6 group-hover/card:translate-x-0 transition ease-custom"
                    />
                  </span>
                </a>
              </h3>
              <p class="text-sm text-primary text-balance">
                Espresso machines, drippers, brewers, and bean subscriptions
                that coffee lovers will actually use every day.
              </p>
            </header>
            <time class="text-primary/70 mt-auto text-xs uppercase font-mono">
              {
                new Date("2025-12-01").toLocaleDateString("en-us", {
                  timeZone: "America/New_York",
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })
              }
            </time>
          </div>
          <div
            class:list={[
              "relative overflow-hidden w-1/2 hidden",
              "group-[&:nth-child(2n+1)]/list-item:block",
              "md:group-[&:nth-child(2n+1)]/list-item:hidden",
              "md:group-[&:nth-child(3n+1)]/list-item:block",
              "lg:group-[&:nth-child(3n+1)]/list-item:hidden",
              "lg:group-[&:nth-child(6n+1)]/list-item:block",
              "lg:group-[&:nth-child(6n)]/list-item:block",
            ]}
          >
            <Image
              src="/img/holidays.jpg"
              alt=""
              width={1500}
              height={1000}
              class="absolute size-full object-cover"
            />
          </div>
          <canvas
            id="snowCanvas"
            class="absolute inset-0 size-full pointer-events-none"></canvas>
        </article>
      </li>
      {
        interviews.map(({ id, data }) => {
          const { avatar, title, description, published, gallery } = data;
          const slug = getSlugFromId(id);
          const thumbnail = gallery?.at(0);
          return (
            <li
              class:list={[
                "flex flex-col group/list-item",
                "md:[&:nth-child(3n+1)]:col-span-2",
                "lg:[&:nth-child(3n+1)]:col-span-1",
                "lg:[&:nth-child(6n+1)]:col-span-2",
                "lg:[&:nth-child(6n)]:col-span-2",
              ]}
            >
              <article
                class:list={[
                  "group/card isolate relative rounded-lg flex-1 flex overflow-hidden bg-muted",
                  "group-[&:nth-child(2n+1)]/list-item:bg-accent",
                  "md:group-[&:nth-child(2n+1)]/list-item:bg-muted",
                  "md:group-[&:nth-child(3n+1)]/list-item:bg-accent",
                  "lg:group-[&:nth-child(3n+1)]/list-item:bg-muted",
                  "lg:group-[&:nth-child(6n+1)]/list-item:bg-accent",
                  "lg:group-[&:nth-child(6n)]/list-item:bg-accent",
                ]}
              >
                <div class="p-4 sm:p-8 flex-1 flex flex-col">
                  <header class="mb-24 sm:mb-56">
                    <div class="mb-4 size-9 relative overflow-hidden rounded-full">
                      <Image
                        src={avatar}
                        width={32}
                        height={32}
                        alt=""
                        class="absolute size-full"
                      />
                    </div>
                    <h3 class="font-semibold tracking-tight">
                      <a
                        href={`/interviews/${slug}`}
                        class="before:absolute before:inset-0 before:z-10"
                      >
                        {title}
                        <span class="absolute h-[1lh] inline-flex items-center pl-1 overflow-clip">
                          <Icon
                            name="arrow-right"
                            class="size-4 opacity-0 group-hover/card:opacity-70 motion-reduce:transition-none duration-250 -translate-x-6 group-hover/card:translate-x-0 transition ease-custom"
                          />
                        </span>
                      </a>
                    </h3>
                    <p class="line-clamp-2 text-sm opacity-70 text-balance">
                      {description}
                    </p>
                  </header>
                  <time class="opacity-70 mt-auto text-xs uppercase font-mono">
                    {published.toLocaleDateString("en-us", {
                      timeZone: "America/New_York",
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                    })}
                  </time>
                </div>
                {thumbnail ? (
                  <div
                    class:list={[
                      "relative overflow-hidden w-1/2 hidden",
                      "group-[&:nth-child(2n+1)]/list-item:block",
                      "md:group-[&:nth-child(2n+1)]/list-item:hidden",
                      "md:group-[&:nth-child(3n+1)]/list-item:block",
                      "lg:group-[&:nth-child(3n+1)]/list-item:hidden",
                      "lg:group-[&:nth-child(6n+1)]/list-item:block",
                      "lg:group-[&:nth-child(6n)]/list-item:block",
                    ]}
                  >
                    <Image
                      src={thumbnail.src}
                      alt={thumbnail.alt}
                      width={1500}
                      height={1000}
                      class="absolute size-full object-cover"
                    />
                  </div>
                ) : null}
              </article>
            </li>
          );
        })
      }
    </ul>
  </section>
</Layout>

<script>
  const canvas = document.getElementById("snowCanvas") as HTMLCanvasElement;
  const gl =
    canvas.getContext("webgl") ||
    (canvas.getContext("experimental-webgl") as WebGLRenderingContext);

  if (!gl) {
    console.error("WebGL not supported");
  }

  function resize() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    if (gl) gl.viewport(0, 0, canvas.width, canvas.height);
  }
  resize();
  window.addEventListener("resize", resize);

  const vertexShaderSource = `
            attribute vec2 a_position;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
            }
        `;

  const fragmentShaderSource = `
            precision mediump float;
            uniform vec2 u_resolution;
            uniform float u_time;

            float hash(vec2 p) {
                return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453);
            }

            float snow(vec2 uv, float scale, float speed, float layer) {
                uv *= scale;
                uv.y += u_time * speed;
                uv.x += sin(uv.y * 0.5 + layer * 3.14) * 0.2;

                vec2 id = floor(uv);
                vec2 gv = fract(uv) - 0.5;

                float n = hash(id + vec2(layer, 0.0));

                float x = (n - 0.5) * 0.8;
                float y = (hash(id + vec2(layer, 1.0)) - 0.5) * 0.8;

                vec2 p = gv - vec2(x, y);
                float d = length(p);

                float size = 0.05 + n * 0.05;
                float flake = smoothstep(size, 0.0, d);

                return flake * (0.5 + n * 0.5);
            }

            void main() {
                vec2 uv = (gl_FragCoord.xy - 0.5 * u_resolution.xy) / u_resolution.y;

                float col = 0.0;

                col += snow(uv, 5.0, 0.1, 0.0) * 0.8;
                col += snow(uv, 8.0, 0.15, 1.0) * 0.9;
                col += snow(uv, 12.0, 0.22, 2.0) * 1.0;
                col += snow(uv, 18.0, 0.3, 3.0) * 0.7;
                col += snow(uv, 25.0, 0.4, 4.0) * 0.5;

                vec3 color = vec3(col);
                gl_FragColor = vec4(color, col * 0.9);
            }
        `;

  function createShader(
    gl: WebGLRenderingContext,
    type: number,
    source: string
  ) {
    const shader = gl.createShader(type) as WebGLShader;
    gl.shaderSource(shader, source);
    gl.compileShader(shader);

    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
      console.error("Shader compile error:", gl.getShaderInfoLog(shader));
      gl.deleteShader(shader);
      return null;
    }
    return shader;
  }

  function createProgram(
    gl: WebGLRenderingContext,
    vertexShader: WebGLShader,
    fragmentShader: WebGLShader
  ) {
    const program = gl.createProgram() as WebGLProgram;
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    gl.linkProgram(program);

    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
      console.error("Program link error:", gl.getProgramInfoLog(program));
      return null;
    }
    return program;
  }

  const vertexShader = createShader(
    gl,
    gl.VERTEX_SHADER,
    vertexShaderSource
  ) as WebGLShader;
  const fragmentShader = createShader(
    gl,
    gl.FRAGMENT_SHADER,
    fragmentShaderSource
  ) as WebGLShader;
  const program = createProgram(
    gl,
    vertexShader,
    fragmentShader
  ) as WebGLProgram;

  const positionLocation = gl.getAttribLocation(program, "a_position");
  const resolutionLocation = gl.getUniformLocation(program, "u_resolution");
  const timeLocation = gl.getUniformLocation(program, "u_time");

  const positionBuffer = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
  gl.bufferData(
    gl.ARRAY_BUFFER,
    new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]),
    gl.STATIC_DRAW
  );

  gl.enable(gl.BLEND);
  gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

  let startTime = Date.now();

  function render() {
    const time = (Date.now() - startTime) * 0.001;

    gl.clearColor(0, 0, 0, 0);
    gl.clear(gl.COLOR_BUFFER_BIT);

    gl.useProgram(program);

    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    gl.enableVertexAttribArray(positionLocation);
    gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

    gl.uniform2f(resolutionLocation, canvas.width, canvas.height);
    gl.uniform1f(timeLocation, time);

    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

    requestAnimationFrame(render);
  }

  render();
</script>
