---
import Layout from "@/layouts/Layout.astro";
import { getSlugFromId, getIndexById, isProd } from "@/utils";
import {
  type CollectionEntry,
  getCollection,
  getEntry,
  render,
} from "astro:content";
import { Image } from "astro:assets";
import Sponsor from "@/components/sponsor.astro";
export async function getStaticPaths() {
  const collection = await getCollection("interviews", ({ data }) => {
    return isProd ? data.draft !== true : true;
  });
  const interviews = collection.sort((a, b) => {
    const aDate = a.data.published;
    const bDate = b.data.published;
    return Date.parse(bDate.toString()) - Date.parse(aDate.toString());
  });
  return interviews.map((interview, index) => {
    const id = getSlugFromId(interview.id);
    const issue = getIndexById(interviews, interview.id);
    const totalIssues = interviews.length;
    const previous =
      index < totalIssues - 1 ? interviews[index + 1] : undefined;
    const next = index > 0 ? interviews[index - 1] : undefined;
    return {
      params: { id },
      props: {
        issue,
        interview,
        previous,
        next,
      },
    };
  });
}
type Props = {
  issue: string;
  interview: CollectionEntry<"interviews">;
  previous: CollectionEntry<"interviews"> | undefined;
  next: CollectionEntry<"interviews"> | undefined;
};
const { issue, interview, previous, next } = Astro.props;
const { Content } = await render(interview);
---

<Layout
  title={interview.data.title}
  description={interview.data.description}
  image={interview.data.image}
>
  <header class="mt-8">
    <p class="mb-2 text-muted-foreground font-mono uppercase text-xs">
      Issue {issue} // {
        interview.data.published.toLocaleDateString("en-us", {
          timeZone: "America/New_York",
          year: "numeric",
          month: "short",
          day: "numeric",
        })
      }
    </p>
    <h1 class="mb-1 font-bold text-4xl tracking-tight">
      {interview.data.title}
    </h1>
    <p class="text-2xl font-medium max-3xl text-balance text-muted-foreground">
      {interview.data.description}
    </p>
  </header>
  {
    interview.data.gallery ? (
      <figure class:list={["embla", "relative mt-8"]}>
        <div class:list={["embla__viewport", "overflow-hidden bg-black/5"]}>
          <div class:list={["embla__container", "flex"]}>
            {interview.data.gallery.map((img, i) => {
              return (
                <div
                  class:list={[
                    "embla__slide",
                    "relative overflow-hidden aspect-[3/2] flex-[0_0_100%] min-w-0 grid place-content-center",
                  ]}
                >
                  <Image
                    src={img.src}
                    alt={img.alt}
                    width={1500}
                    height={1000}
                    loading={i === 0 ? "eager" : "lazy"}
                    style={`--object-position:${img.position || "center"}`}
                    class:list={[
                      "absolute w-full h-full object-cover object-[var(--object-position)]",
                    ]}
                  />
                  <span class="absolute top-4 left-4 text-xs uppercase font-mono text-accent">
                    FIG_{(i + 1).toString().padStart(3, "0")}
                  </span>
                </div>
              );
            })}
          </div>
        </div>
        {interview.data.gallery.length > 1 ? (
          <Fragment>
            <button
              class:list={[
                "embla__button--prev",
                "absolute top-1/2 -translate-y-1/2 size-8 bg-accent grid place-content-center left-0",
                "disabled:opacity-0",
              ]}
              disabled
              type="button"
            >
              <span class="sr-only">Previous</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="size-6"
              >
                <path d="m12 19-7-7 7-7" />
                <path d="M19 12H5" />
              </svg>
            </button>
            <button
              class:list={[
                "embla__button--next",
                "absolute top-1/2 -translate-y-1/2 size-8 bg-accent grid place-content-center right-0",
                "disabled:opacity-0",
              ]}
              type="button"
            >
              <span class="sr-only">Next</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="size-6"
              >
                <path d="M5 12h14" />
                <path d="m12 5 7 7-7 7" />
              </svg>
            </button>
            <div
              class:list={[
                "embla__dots",
                "flex justify-center gap-x-2 mt-4 h-2 items-center",
                "*:size-2 *:bg-black/20 [&_.active]:bg-neutral-950",
              ]}
            />
          </Fragment>
        ) : null}
      </figure>
    ) : null
  }

  <!-- <div class="mt-8">
    <Sponsor />
  </div> -->

  <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-x-8 md:gap-x-12 gap-y-8">
    <div class="sm:col-span-2">
      <div class="prose">
        <Content />
      </div>
      {
        interview.data.products ? (
          <>
            <h2 class="mt-8 mb-4 flex items-center gap-x-4 font-semibold text-xl tracking-tight">
              Products referenced&nbsp;&not;
            </h2>
            <ul class="space-y-4">
              {interview.data.products?.map(async ({ id }, i) => {
                const product = await getEntry("products", id);
                if (!product) {
                  return null;
                }
                return (
                  <li id={(i + 1).toString()}>
                    <span class="text-muted-foreground font-mono uppercase text-xs block">
                      {product.data.description}
                    </span>
                    <a
                      href={product.data.link}
                      target="_blank"
                      class="font-medium underline decoration-2 decoration-accent hover:bg-accent"
                    >
                      {product.data.title}
                    </a>
                  </li>
                );
              })}
            </ul>
          </>
        ) : null
      }
    </div>
    <div class="sm:col-span-1 flex flex-col">
      <figure class="aspect-square relative overflow-hidden">
        <img
          src={interview.data.avatar}
          alt=""
          class="w-full absolute h-full object-cover"
        />
        {
          interview.data.gallery ? (
            <span class="absolute top-4 left-4 text-xs uppercase font-mono text-accent">
              {`FIG_${(interview.data.gallery.length + 1).toString().padStart(3, "0")}`}
            </span>
          ) : null
        }
      </figure>
      {
        interview.data.social ? (
          <dl
            class:list={[
              "mt-4 mb-8 [&_dt]:not-first:mt-2 [&_dt]:pt-2 [&_dt]:border-t [&_dt]:border-dashed [&_dt]:border-black/20 [&_dt]:font-mono [&_dt]:uppercase [&_dt]:text-xs [&_dt]:text-muted-foreground",
              "[&_dd]:font-medium [&_dd]:truncate",
            ]}
          >
            {interview.data.social?.twitter ? (
              <>
                <dt>Twitter</dt>
                <dd>
                  <a
                    href={`https://x.com/${interview.data.social?.twitter}`}
                    target="_blank"
                    class="underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    @{interview.data.social?.twitter}
                  </a>
                </dd>
              </>
            ) : null}
            {interview.data.social?.bluesky ? (
              <>
                <dt>Bluesky</dt>
                <dd>
                  <a
                    href={`https://bsky.app/profile/${interview.data.social?.bluesky}`}
                    target="_blank"
                    class="underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    @{interview.data.social?.bluesky}
                  </a>
                </dd>
              </>
            ) : null}
            {interview.data.social?.instagram ? (
              <>
                <dt>Instagram</dt>
                <dd>
                  <a
                    href={`https://instagram.com/${interview.data.social?.instagram}`}
                    target="_blank"
                    class="underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    @{interview.data.social?.instagram}
                  </a>
                </dd>
              </>
            ) : null}
            {interview.data.social?.youtube ? (
              <>
                <dt>YouTube</dt>
                <dd>
                  <a
                    href={`https://www.youtube.com/${interview.data.social?.youtube}`}
                    target="_blank"
                    class="underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    {interview.data.social?.youtube}
                  </a>
                </dd>
              </>
            ) : null}
            {interview.data.social?.website ? (
              <>
                <dt>Website</dt>
                <dd>
                  <a
                    href={interview.data.social?.website}
                    target="_blank"
                    class="underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    {new URL(interview.data.social?.website).hostname.replace(
                      "www.",
                      ""
                    )}
                  </a>
                </dd>
              </>
            ) : null}
          </dl>
        ) : null
      }

      {
        (next || previous) && (
          <nav class="bg-black/5 mt-auto">
            <ul>
              {next ? (
                <li class="p-4">
                  <p class="text-muted-foreground text-xs uppercase font-mono">
                    Next issue
                  </p>
                  <a
                    href={getSlugFromId(next.id)}
                    class="font-medium underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    {next.data.title}
                  </a>
                </li>
              ) : null}
              {previous ? (
                <li
                  class:list={[
                    "p-4",
                    {
                      "border-t border-dashed border-black/20": next,
                    },
                  ]}
                >
                  <p class="text-xs text-muted-foreground uppercase font-mono">
                    Previous issue
                  </p>
                  <a
                    href={getSlugFromId(previous.id)}
                    class="font-medium underline decoration-2 decoration-accent hover:bg-accent"
                  >
                    {previous.data.title}
                  </a>
                </li>
              ) : null}
            </ul>
          </nav>
        )
      }
    </div>
  </div>
</Layout>

<script>
  import {
    addDotBtnsAndClickHandlers,
    addPrevNextBtnsClickHandlers,
  } from "@/utils/embla";
  import EmblaCarousel, { type EmblaOptionsType } from "embla-carousel";
  const OPTIONS: EmblaOptionsType = {};

  (function () {
    const emblaNode = document.querySelector(".embla") as HTMLElement;

    if (!emblaNode) {
      return;
    }

    const viewportNode = emblaNode.querySelector(
      ".embla__viewport"
    ) as HTMLElement;
    const prevBtnNode = emblaNode.querySelector(
      ".embla__button--prev"
    ) as HTMLElement;
    const nextBtnNode = emblaNode.querySelector(
      ".embla__button--next"
    ) as HTMLElement;
    const dotsNode = emblaNode.querySelector(".embla__dots") as HTMLElement;

    if (!dotsNode) {
      return;
    }

    const emblaApi = EmblaCarousel(viewportNode, OPTIONS);

    const removePrevNextBtnsClickHandlers = addPrevNextBtnsClickHandlers(
      emblaApi,
      prevBtnNode,
      nextBtnNode
    );
    const removeDotBtnsAndClickHandlers = addDotBtnsAndClickHandlers(
      emblaApi,
      dotsNode
    );

    emblaApi.on("destroy", removePrevNextBtnsClickHandlers);
    emblaApi.on("destroy", removeDotBtnsAndClickHandlers);
  })();
</script>
